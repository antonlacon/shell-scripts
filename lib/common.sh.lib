# common.sh.lib v20120414
#
# Copyright 2011-2012: Ian Leonard <antonlacon@gmail.com>
# License: GNU GPLv3 -
# Warranty: No warranty, express or implied.
#
# Stores common functions for shell scripts
#
# Functions:
# die
# generate_alphanumeric
# generate_alphanumeric_string
# tmp_clean
# tmp_random_name

# die(msg, code) - exit with a message and exit code

die() {
	echo "$1" # echo command's death report
	# use provided exit signal or default to 1
	if [ -n "$2" ]; then
		exit "$2"
	else
		exit 1
	fi
}

# generate_alphanumeric()
# output a single alphanumeric character

generate_alphanumeric() {
# [a-zA-Z0-9]
local character_array=(a b c d e f g h i j k l m n o p q r s t u v w x y z A B C D E F G H I J K L M N O P Q R S T U V W X Y Z 0 1 2 3 4 5 6 7 8 9)

# choose a random number between 0 and 61 (26 lowercase, 26 uppercase, 10 digits)
local i=$RANDOM

while [ $i -gt 61 ]; do
	i=$RANDOM
done

echo ${character_array[$i]}
}

# generate_alphanumeric_string(int)
# output an alphanumeric string of length positive int
#

generate_alphanumeric_string() {
	local name_length=$1
	local tmp_string=""
	local i=0

	# test if temp_dir/tmp_name exists, if it does, repeat
	while [ $i -lt $name_length ]; do
		tmp_string=$tmp_string$( generate_alphanumeric )
		(( i = i+1 ))
	done
	echo $tmp_string
}

# tmp_clean()
# used to periodically clean /tmp of a running system
# checks to see if file is in use by a program, and if it's older than X minutes/hrs/days.
#
# look at tmpwatch and/or fuser and ls (atime) to find correct solution
#

# tmp_random_name()
# Create a temporary filename for use by another command
# Name wll be alphanumeric not currently in the designated directory
# Essentially, try to mimic mktemp only create a name for a file, rather than the file
#
# NOTE: There is no guarantee this filename will remain free, making this potentially unsafe.
#
# requires the following to be set
# TEMP_DIR
# PN

tmp_random_name() {
local tmp_name=$( generate_alphanumeric_string 10 )

while [ -e "${TEMP_DIR}/${PN}.$tmp_name" ]; do
	tmp_name=$( generate alphanumeric_string 10 )	
done
echo "$PN.$tmp_name"

}

